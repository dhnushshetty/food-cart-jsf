<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Browse Shops - NitteEats</title>
    <link rel="stylesheet" href="/css/main.css">
    <link rel="stylesheet" href="/css/animations.css">
    <link rel="stylesheet" href="/css/components.css">
</head>
<body>
    <!-- Navigation Bar -->
    <nav class="navbar">
        <div class="navbar-container">
            <a href="/" class="navbar-brand">üçï NitteEats</a>
            <div class="navbar-links" id="navLinks"></div>
        </div>
    </nav>
    
    <!-- Main Content -->
    <div class="container py-8">
        <!-- Personalized Greeting -->
        <div id="customerGreeting" style="display: none; margin-bottom: 2rem; padding: 2rem; background: linear-gradient(135deg, var(--primary-700) 0%, var(--secondary-700) 100%); border-radius: var(--radius-xl); text-align: center;">
            <h2 class="text-3xl font-bold mb-2 text-white animate-fade-in" id="greetingText"></h2>
            <p class="text-lg text-white" style="opacity: 0.9;">Discover delicious food from local vendors</p>
        </div>
        
        <h1 class="text-4xl font-bold mb-8">Browse Shops</h1>
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6" id="shopsGrid">
            <!-- Shops will be loaded here -->
        </div>
    </div>
    
    <!-- Menu Modal -->
    <div id="menuModal" class="modal">
        <div class="modal-backdrop"></div>
        <div class="modal-content animate-slide-in-up">
            <div class="modal-header">
                <h2 class="modal-title" id="modalShopName"></h2>
                <button class="modal-close" onclick="closeMenuModal()">&times;</button>
            </div>
            <div class="modal-body" id="menuItems">
                <!-- Menu items will be loaded here -->
            </div>
        </div>
    </div>
    
    <!-- Scripts -->
    <script src="/js/utils.js"></script>
    <script src="/js/animations.js"></script>
    <script src="/js/toast.js"></script>
    <script>
        const auth = getAuthState();
        
        // Update navigation
        const navLinks = document.getElementById('navLinks');
        if (auth.isAuthenticated) {
            if (auth.isCustomer) {
                navLinks.innerHTML = `
                    <a href="/shops" class="navbar-link active">Browse Shops</a>
                    <a href="/cart" class="navbar-link cart-badge">üõí Cart</a>
                    <a href="/orders" class="navbar-link">üì¶ Orders</a>
                    <a href="#" class="navbar-link" onclick="logout()">Logout</a>
                `;
                refreshCartBadge();
                
                // Show personalized greeting
                showCustomerGreeting();
            } else if (auth.isOwner) {
                navLinks.innerHTML = `
                    <a href="/owner/dashboard" class="navbar-link">üìä Dashboard</a>
                    <a href="#" class="navbar-link" onclick="logout()">Logout</a>
                `;
            }
        } else {
            navLinks.innerHTML = `
                <a href="/shops" class="navbar-link active">Browse Shops</a>
                <a href="/login" class="navbar-link">Login</a>
                <a href="/register" class="navbar-link">Register</a>
            `;
        }
        
        // Show personalized greeting for customers
        function showCustomerGreeting() {
            const username = auth.username || 'Guest';
            const greetingContainer = document.getElementById('customerGreeting');
            const greetingText = document.getElementById('greetingText');
            
            // Get time-based greeting
            const hour = new Date().getHours();
            let timeGreeting = 'Hello';
            if (hour < 12) {
                timeGreeting = 'Good Morning';
            } else if (hour < 18) {
                timeGreeting = 'Good Afternoon';
            } else {
                timeGreeting = 'Good Evening';
            }
            
            // Set greeting text
            greetingText.textContent = `${timeGreeting}, ${username}! What would you like to order today?`;
            
            // Show greeting with animation
            greetingContainer.style.display = 'block';
            greetingContainer.classList.add('animate-slide-in-down');
        }
        
        // Load shops with skeleton loading
        async function loadShops() {
            const grid = document.getElementById('shopsGrid');
            
            // Show skeleton loading
            showSkeletonLoading(grid, 6);
            
            try {
                const response = await fetch('/api/shops');
                const shops = await response.json();
                
                if (shops.length === 0) {
                    grid.innerHTML = `
                        <div class="empty-state" style="grid-column: 1 / -1;">
                            <div class="empty-state-icon">üè™</div>
                            <h2 class="empty-state-title">No Shops Available</h2>
                            <p class="empty-state-description">Check back later for new food vendors</p>
                        </div>
                    `;
                    return;
                }
                
                // Render shops
                grid.innerHTML = shops.map(shop => `
                    <div class="card hover-lift animate-fade-in" onclick="viewMenu(${shop.id}, '${escapeHtml(shop.shopName)}')">
                        <div class="card-image" style="position: relative; overflow: hidden;">
                            ${shop.imageUrl ? 
                                `<img src="${shop.imageUrl}" alt="${escapeHtml(shop.shopName)}" style="width: 100%; height: 100%; object-fit: cover;" onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">
                                <div style="display:none; background: linear-gradient(135deg, var(--primary-600) 0%, var(--secondary-600) 100%); width: 100%; height: 100%; align-items: center; justify-content: center; font-size: 4rem;">üè™</div>` :
                                `<div style="display: flex; background: linear-gradient(135deg, var(--primary-600) 0%, var(--secondary-600) 100%); width: 100%; height: 100%; align-items: center; justify-content: center; font-size: 4rem;">üè™</div>`
                            }
                        </div>
                        <div class="card-content">
                            <h3 class="card-title">${escapeHtml(shop.shopName)}</h3>
                            <p class="card-description">${escapeHtml(shop.description)}</p>
                            <p class="text-gray-600 text-sm mt-2">üìç ${escapeHtml(shop.address)}</p>
                        </div>
                    </div>
                `).join('');
                
                // Stagger fade-in animation
                const cards = grid.querySelectorAll('.card');
                fadeInStagger(cards, 100);
                
            } catch (error) {
                console.error('Error loading shops:', error);
                grid.innerHTML = `
                    <div class="empty-state" style="grid-column: 1 / -1;">
                        <div class="empty-state-icon">‚ö†Ô∏è</div>
                        <h2 class="empty-state-title">Error Loading Shops</h2>
                        <p class="empty-state-description">Please try again later</p>
                    </div>
                `;
                toast.error('Failed to load shops. Please try again.');
            }
        }
        
        // View menu modal
        async function viewMenu(shopId, shopName) {
            const modal = document.getElementById('menuModal');
            const menuItems = document.getElementById('menuItems');
            
            document.getElementById('modalShopName').textContent = shopName;
            
            // Show loading
            showSpinner(menuItems);
            openModal(modal);
            
            try {
                const response = await fetch(`/api/shops/${shopId}/menu`);
                const menu = await response.json();
                
                if (menu.length === 0) {
                    menuItems.innerHTML = `
                        <div class="empty-state">
                            <div class="empty-state-icon">üçΩÔ∏è</div>
                            <h3 class="empty-state-title">No Menu Items</h3>
                            <p class="empty-state-description">This shop hasn't added any items yet</p>
                        </div>
                    `;
                    return;
                }
                
                menuItems.innerHTML = menu.map(item => `
                    <div class="card card-flat mb-4 animate-fade-in" style="display: flex; flex-direction: row; align-items: center; gap: 1.5rem; padding: 1.5rem; background: linear-gradient(135deg, #1e293b 0%, #2d3748 100%);">
                        ${item.imageUrl ? 
                            `<img src="${item.imageUrl}" alt="${escapeHtml(item.name)}" class="menu-item-image" style="width: 100px; height: 100px; object-fit: cover; border-radius: var(--radius-lg); flex-shrink: 0; border: 2px solid rgba(79, 70, 229, 0.3);" onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">
                            <div class="menu-item-image-placeholder" style="display:none; width: 100px; height: 100px; background: rgba(79, 70, 229, 0.2); border-radius: var(--radius-lg); align-items: center; justify-content: center; font-size: 2.5rem; flex-shrink: 0; border: 2px solid rgba(79, 70, 229, 0.3);">üçΩÔ∏è</div>` :
                            `<div class="menu-item-image-placeholder" style="display: flex; width: 100px; height: 100px; background: rgba(79, 70, 229, 0.2); border-radius: var(--radius-lg); align-items: center; justify-content: center; font-size: 2.5rem; flex-shrink: 0; border: 2px solid rgba(79, 70, 229, 0.3);">üçΩÔ∏è</div>`
                        }
                        <div style="flex: 1;">
                            <h4 class="text-xl font-bold mb-2" style="color: var(--gray-100);">${escapeHtml(item.name)}</h4>
                            <p class="mb-2" style="color: var(--gray-400); line-height: 1.6;">${escapeHtml(item.description)}</p>
                            <p class="text-2xl font-bold" style="color: var(--success);">‚Çπ${item.price}</p>
                        </div>
                        ${auth.isCustomer ? `
                            <div style="display: flex; flex-direction: column; gap: 0.75rem; align-items: center;">
                                <div class="quantity-selector">
                                    <button class="quantity-btn" onclick="decrementQty(${item.id})">‚àí</button>
                                    <span class="quantity-value" id="qty-${item.id}">1</span>
                                    <button class="quantity-btn" onclick="incrementQty(${item.id})">+</button>
                                </div>
                                <button class="btn btn-primary btn-sm" onclick="addToCart(event, ${item.id}, '${escapeHtml(item.name).replace(/'/g, "\\'")}')">
                                    Add to Cart
                                </button>
                            </div>
                        ` : ''}
                    </div>
                `).join('');
                
            } catch (error) {
                console.error('Error loading menu:', error);
                menuItems.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">‚ö†Ô∏è</div>
                        <h3 class="empty-state-title">Error Loading Menu</h3>
                        <p class="empty-state-description">Please try again</p>
                    </div>
                `;
                toast.error('Failed to load menu. Please try again.');
            }
        }
        
        // Quantity controls
        function incrementQty(itemId) {
            const qtyElement = document.getElementById('qty-' + itemId);
            let qty = parseInt(qtyElement.textContent);
            if (qty < 99) {
                qtyElement.textContent = qty + 1;
            }
        }
        
        function decrementQty(itemId) {
            const qtyElement = document.getElementById('qty-' + itemId);
            let qty = parseInt(qtyElement.textContent);
            if (qty > 1) {
                qtyElement.textContent = qty - 1;
            }
        }
        
        // Add to cart with animation
        async function addToCart(event, menuItemId, itemName) {
            if (!auth.isAuthenticated) {
                window.location.href = '/login';
                return;
            }
            
            const button = event.target;
            const qtyElement = document.getElementById('qty-' + menuItemId);
            const quantity = parseInt(qtyElement.textContent) || 1;
            
            // Add ripple effect
            createRipple(event);
            
            // Disable button
            const originalText = button.textContent;
            button.disabled = true;
            button.innerHTML = '<span class="spinner spinner-sm"></span>';
            
            try {
                const response = await fetch('/api/cart/add', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': 'Bearer ' + auth.token
                    },
                    body: JSON.stringify({ menuItemId: menuItemId, quantity: quantity })
                });
                
                if (response.ok) {
                    // Show success toast
                    toast.success(`‚úì ${quantity}x ${itemName} added to cart!`);
                    
                    // Animate flying to cart
                    animateFlyToCart(button, itemName);
                    
                    // Update cart badge
                    refreshCartBadge();
                    
                    // Reset quantity
                    qtyElement.textContent = '1';
                    
                } else {
                    const errorText = await response.text();
                    if (errorText.includes('different shop')) {
                        toast.error('‚ö† Cannot add items from different shops! Please clear your cart first.');
                    } else {
                        toast.error(errorText || 'Failed to add item to cart');
                    }
                }
            } catch (error) {
                console.error('Error adding to cart:', error);
                toast.error('Error adding item to cart. Please try again.');
            } finally {
                button.disabled = false;
                button.textContent = originalText;
            }
        }
        
        // Close modal
        function closeMenuModal() {
            closeModal(document.getElementById('menuModal'));
        }
        
        // Close modal on backdrop click
        document.querySelector('.modal-backdrop')?.addEventListener('click', closeMenuModal);
        
        // Load shops on page load
        loadShops();
    </script>
</body>
</html>
