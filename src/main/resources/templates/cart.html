<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Cart - Food Cart Platform</title>
    <link rel="stylesheet" href="/css/main.css">
    <link rel="stylesheet" href="/css/animations.css">
    <link rel="stylesheet" href="/css/components.css">
</head>
<body>
    <!-- Navigation Bar -->
    <nav class="navbar">
        <div class="navbar-container">
            <a href="/" class="navbar-brand">üçï Food Cart Platform</a>
            <div class="navbar-links">
                <a href="/shops" class="navbar-link">Browse Shops</a>
                <a href="/cart" class="navbar-link active cart-badge">üõí Cart</a>
                <a href="/orders" class="navbar-link">üì¶ Orders</a>
                <a href="#" class="navbar-link" onclick="logout()">Logout</a>
            </div>
        </div>
    </nav>
    
    <!-- Main Content -->
    <div class="container py-8">
        <h1 class="text-4xl font-bold mb-8">My Cart</h1>
        
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
            <!-- Cart Items -->
            <div class="lg:col-span-2">
                <div id="cartItems">
                    <!-- Cart items will be loaded here -->
                </div>
            </div>
            
            <!-- Order Summary (Sticky on mobile) -->
            <div class="lg:col-span-1">
                <div class="card" id="orderSummary" style="position: sticky; top: 1rem; display: none;">
                    <div class="card-content">
                        <h3 class="text-2xl font-bold mb-6">Order Summary</h3>
                        
                        <div class="flex justify-between mb-4 pb-4 border-bottom">
                            <span class="text-gray-600">Subtotal</span>
                            <span class="font-semibold" id="subtotal">‚Çπ0.00</span>
                        </div>
                        
                        <div class="flex justify-between mb-6 pb-6 border-bottom">
                            <span class="text-xl font-bold">Total</span>
                            <span class="text-2xl font-bold" style="color: var(--success);" id="total">‚Çπ0.00</span>
                        </div>
                        
                        <button class="btn btn-primary" style="width: 100%;" onclick="placeOrder()">
                            Place Order
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Scripts -->
    <script src="/js/utils.js"></script>
    <script src="/js/animations.js"></script>
    <script src="/js/toast.js"></script>
    <script src="/js/cart-overlay.js"></script>
    <script>
        // Require authentication
        requireAuth();
        requireRole('ROLE_CUSTOMER');
        
        const auth = getAuthState();
        
        // Load cart
        async function loadCart() {
            const container = document.getElementById('cartItems');
            const orderSummary = document.getElementById('orderSummary');
            
            // Show loading
            showSpinner(container);
            
            try {
                const response = await fetch('/api/cart', {
                    headers: { 'Authorization': 'Bearer ' + auth.token }
                });
                
                const cart = await response.json();
                
                if (!cart.items || cart.items.length === 0) {
                    container.innerHTML = `
                        <div class="empty-state">
                            <div class="empty-state-icon">üõí</div>
                            <h2 class="empty-state-title">Your cart is empty</h2>
                            <p class="empty-state-description">Browse shops and add delicious items to your cart</p>
                            <a href="/shops" class="btn btn-primary mt-6">Browse Shops</a>
                        </div>
                    `;
                    orderSummary.style.display = 'none';
                    return;
                }
                
                // Render cart items
                container.innerHTML = cart.items.map(item => `
                    <div class="card mb-4 animate-fade-in" data-item-id="${item.id}">
                        <div class="card-content" style="display: flex; gap: 1rem; align-items: center;">
                            ${item.imageUrl ? 
                                `<img src="${item.imageUrl}" alt="${escapeHtml(item.menuItemName)}" style="width: 80px; height: 80px; object-fit: cover; border-radius: var(--radius-lg); flex-shrink: 0;" onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">
                                <div style="display:none; width: 80px; height: 80px; background: var(--gray-200); border-radius: var(--radius-lg); align-items: center; justify-content: center; font-size: 2rem; flex-shrink: 0;">üçΩÔ∏è</div>` :
                                `<div style="display: flex; width: 80px; height: 80px; background: var(--gray-200); border-radius: var(--radius-lg); align-items: center; justify-content: center; font-size: 2rem; flex-shrink: 0;">üçΩÔ∏è</div>`
                            }
                            <div style="flex: 1;">
                                <h3 class="text-xl font-bold mb-2">${escapeHtml(item.menuItemName)}</h3>
                                <p class="text-gray-600">‚Çπ${item.price} √ó ${item.quantity} = <span class="font-bold" style="color: var(--success);">‚Çπ${(item.price * item.quantity).toFixed(2)}</span></p>
                            </div>
                            <button class="btn btn-danger" onclick="removeItem(${item.id})">
                                Remove
                            </button>
                        </div>
                    </div>
                `).join('');
                
                // Update order summary
                document.getElementById('subtotal').textContent = '‚Çπ' + cart.totalAmount;
                document.getElementById('total').textContent = '‚Çπ' + cart.totalAmount;
                orderSummary.style.display = 'block';
                
                // Update cart badge
                const totalItems = cart.items.reduce((sum, item) => sum + item.quantity, 0);
                updateCartBadge(totalItems);
                
            } catch (error) {
                console.error('Error loading cart:', error);
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">‚ö†Ô∏è</div>
                        <h2 class="empty-state-title">Error Loading Cart</h2>
                        <p class="empty-state-description">Please try again</p>
                    </div>
                `;
                toast.error('Failed to load cart. Please try again.');
            }
        }
        
        // Remove item from cart
        async function removeItem(id) {
            const itemCard = document.querySelector(`[data-item-id="${id}"]`);
            
            try {
                const response = await fetch('/api/cart/remove/' + id, {
                    method: 'DELETE',
                    headers: { 'Authorization': 'Bearer ' + auth.token }
                });
                
                if (response.ok) {
                    // Animate removal
                    slideOutAndRemove(itemCard, () => {
                        loadCart();
                        toast.success('Item removed from cart');
                    });
                } else {
                    toast.error('Failed to remove item from cart');
                }
            } catch (error) {
                console.error('Error removing item:', error);
                toast.error('Error removing item from cart');
            }
        }
        
        // Place order
        async function placeOrder() {
            const button = event.target;
            const originalText = button.textContent;
            button.disabled = true;
            button.innerHTML = '<span class="spinner spinner-sm"></span> Placing Order...';
            
            try {
                const response = await fetch('/api/orders/place', {
                    method: 'POST',
                    headers: { 'Authorization': 'Bearer ' + auth.token }
                });
                
                if (response.ok) {
                    // Show success animation
                    toast.success('üéâ Order placed successfully!');
                    
                    // Animate success
                    const container = document.getElementById('cartItems');
                    container.innerHTML = `
                        <div class="empty-state animate-scale-in">
                            <div class="empty-state-icon animate-bounce" style="font-size: 5rem;">‚úì</div>
                            <h2 class="empty-state-title">Order Placed Successfully!</h2>
                            <p class="empty-state-description">Your order is being prepared</p>
                        </div>
                    `;
                    
                    document.getElementById('orderSummary').style.display = 'none';
                    
                    // Redirect to orders page
                    setTimeout(() => {
                        window.location.href = '/orders';
                    }, 2000);
                } else {
                    const error = await response.text();
                    toast.error(error || 'Failed to place order');
                    button.disabled = false;
                    button.textContent = originalText;
                }
            } catch (error) {
                console.error('Error placing order:', error);
                toast.error('Error placing order. Please try again.');
                button.disabled = false;
                button.textContent = originalText;
            }
        }
        
        // Load cart on page load
        loadCart();
    </script>
</body>
</html>
